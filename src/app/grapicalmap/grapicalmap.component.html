<div class="map-container">
  <!-- Product Selector -->
  <div class="product-selector">
    <div class="select-wrapper">
      <select [(ngModel)]="productCode" (change)="onProductChange($event)">
        <option *ngFor="let product of productCodes" [value]="product.value">
          {{ product.name }}
        </option>
      </select>
      <div class="select-arrow">▼</div>
    </div>
  </div>

  <!-- Altitude Slider for Wind/Temp -->
  <div *ngIf="isWindTempSelected" class="altitude-selector">
    <label for="altitude">Altitude: {{ selectedAltitude }}k ft</label>
    <input type="range" id="altitude" min="1" max="51" step="1" [value]="selectedAltitude"
      (input)="onAltitudeChange($event)" />
  </div>

  <!-- Temperature Unit Selector -->
  <div *ngIf="isTemperatureSelected" class="temperature-unit-selector">
    <div class="unit-buttons">
      <button class="unit-btn" 
        [class.active]="selectedTemperatureUnit === 'F'"
        (click)="onTemperatureUnitChange('F')"
        title="Fahrenheit">
        °F
      </button>
      <button class="unit-btn" 
        [class.active]="selectedTemperatureUnit === 'C'"
        (click)="onTemperatureUnitChange('C')"
        title="Celsius">
        °C
      </button>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Custom Legend (Vertical Gradient) -->
  <div *ngIf="displayedLegend.length > 0" class="custom-legend-vertical">
    <div class="legend-container">
      <div class="legend-values">
        <!-- Show high values at top (reverse order of gradient which is to top) -->
        <div *ngFor="let entry of displayedLegend.slice().reverse()" class="legend-label">
          {{ entry.value.replace(' mph', '').replace(' °F', '').replace(' °C', '') }}
        </div>
      </div>
      <div class="legend-bar" [style.background-image]="gradientStyle"></div>
    </div>
    <div class="legend-title">{{ legendTitle }}</div>
  </div>

  <!-- Time Control (Bottom Bar) -->
  <div *ngIf="forecastTimes.length > 0" class="bottom-time-control">
    <div class="control-group left">
      <button class="play-btn" (click)="toggleAnimation()" title="Play/Pause Animation">
        <span *ngIf="!isPlaying">▶</span>
        <span *ngIf="isPlaying">⏸</span>
      </button>

      <button class="nav-btn" (click)="selectPrevTime()" title="Previous Time Step">
        <span>⏮</span>
      </button>

      <!-- Date Selector -->
      <div class="date-selector">
        <button class="date-btn" (click)="toggleCalendar()">
          {{ selectedDate | date:'EEEE, MMM d' }}
          <span class="arrow">▼</span>
        </button>

        <div class="calendar-popup" *ngIf="showCalendar">
          <div class="calendar-grid">
            <button *ngFor="let date of uniqueDates" class="calendar-day" [class.active]="date === selectedDate"
              (click)="selectDate(date)">
              <span class="day-name">{{ date | date:'EEE' }}</span>
              <span class="day-num">{{ date | date:'d' }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="control-group center timeline-wrapper">
      <div class="timeline-track">
        <input type="range" [min]="0" [max]="currentDayTimes.length - 1" [value]="currentIndex"
          (input)="onTimelineInput($event)" 
          (mouseenter)="onTimelineHoverStart()"
          (mousemove)="onTimelineHover($event)"
          (mouseleave)="onTimelineHoverEnd()"
          class="timeline-slider">

        <!-- Hover Time Tooltip -->
        <div class="hover-time-tooltip" *ngIf="isHoveringTimeline && hoverTime" 
          [style.left.%]="hoverPosition">
          {{ hoverTime }}
        </div>

        <div class="timeline-ticks">
          <!-- Render a tick for EVERY 30-min interval -->
          <ng-container *ngFor="let time of currentDayTimes; let i = index">
            <!-- Position based on index -->
            <div class="tick" [class.major]="i % 4 === 0" [class.minor]="i % 2 === 0 && i % 4 !== 0"
              [style.left.%]="(i / (currentDayTimes.length - 1)) * 100">
              <div class="tick-mark"></div>
              <!-- Only label every 2 hours (every 4th 30-min slot) -->
              <span *ngIf="i % 4 === 0" class="tick-label">{{ formatTickTime(time) }}</span>
            </div>
          </ng-container>

          <!-- Current Time Indicator -->
          <div class="current-time-indicator" [style.left.%]="currentTimePosition"
            *ngIf="currentTimePosition > 0 && currentTimePosition < 100">
            <div class="indicator-triangle"></div>
            <div class="indicator-line"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="control-group right">
      <button class="nav-btn" (click)="selectNextTime()" title="Next Time Step">
        <span>⏭</span>
      </button>
    </div>
  </div>
</div>